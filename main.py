agenti_test = [
  { "agent_code": "A007", "agent_name": "Ramasundar", "working_area": "Bangalore", "commission": 0.15, "phone_no": "077-25814763", "country": 'India' },
  { "agent_code": "A003", "agent_name": "Alex", "working_area": "London", "commission": 0.13, "phone_no": "075-12458969", "country": 'UK' },
  { "agent_code": "A008", "agent_name": "Alford", "working_area": "New York", "commission": 0.12, "phone_no": "044-25874365", "country": 'USA' },
  { "agent_code": "A011", "agent_name": "Ravi Kumar", "working_area": "Bangalore", "commission": 0.15, "phone_no": "077-45625874", "country": '' },
  { "agent_code": "A010", "agent_name": "Santakumar", "working_area": "Chennai", "commission": 0.14, "phone_no": "007-22388644", "country": '' },
  { "agent_code": "A012", "agent_name": "Lucida", "working_area": "San Jose", "commission": 0.12, "phone_no": "044-52981425", "country": '' },
  { "agent_code": "A005", "agent_name": "Anderson", "working_area": "Brisban", "commission": 0.13, "phone_no": "045-21447739", "country": '' },
  { "agent_code": "A001", "agent_name": "Subbarao", "working_area": "Bangalore", "commission": 0.14, "phone_no": "077-12346674", "country": '' },
  { "agent_code": "A002", "agent_name": "Mukesh", "working_area": "Mumbai", "commission": 0.11, "phone_no": "029-12358964", "country": '' },
  { "agent_code": "A006", "agent_name": "McDen", "working_area": "London", "commission": 0.15, "phone_no": "078-22255588", "country": '' },
  { "agent_code": "A004", "agent_name": "Ivan", "working_area": "Torento", "commission": 0.15, "phone_no": "008-22544166", "country": '' },
  { "agent_code": "A009", "agent_name": "Benjamin", "working_area": "Hampshair", "commission": 0.11, "phone_no": "008-22536178", "country": '' }
]
clienti_test = [
  { "cust_code": "C00013", "cust_name": "Holmes", "cust_city": "London", "working_area": "London", "cust_country": "UK", "grade": 2, "opening_amt": 6000, "receive_amt": 5000, "payment_amt": 7000, "outstanding_amt": 4000, "phone_no": "BBBBBBB", "agent_code": "A003" },
  { "cust_code": "C00001", "cust_name": "Micheal", "cust_city": "NewYork", "working_area": "NewYork", "cust_country": "USA", "grade": 2, "opening_amt": 3000, "receive_amt": 5000, "payment_amt": 2000, "outstanding_amt": 6000, "phone_no": "CCCCCCC", "agent_code": "A008" },
  { "cust_code": "C00020", "cust_name": "Albert", "cust_city": "NewYork", "working_area": "NewYork", "cust_country": "USA", "grade": 3, "opening_amt": 5000, "receive_amt": 7000, "payment_amt": 6000, "outstanding_amt": 6000, "phone_no": "BBBBSBB", "agent_code": "A008" },
  { "cust_code": "C00025", "cust_name": "Ravindran", "cust_city": "Bangalore", "working_area": "Bangalore", "cust_country": "India", "grade": 2, "opening_amt": 5000, "receive_amt": 7000, "payment_amt": 4000, "outstanding_amt": 8000, "phone_no": "AVAVAVA", "agent_code": "A011" },
  { "cust_code": "C00024", "cust_name": "Cook", "cust_city": "London", "working_area": "London", "cust_country": "UK", "grade": 2, "opening_amt": 4000, "receive_amt": 9000, "payment_amt": 7000, "outstanding_amt": 6000, "phone_no": "FSDDSDF", "agent_code": "A006" },
  { "cust_code": "C00015", "cust_name": "Stuart", "cust_city": "London", "working_area": "London", "cust_country": "UK", "grade": 1, "opening_amt": 6000, "receive_amt": 8000, "payment_amt": 3000, "outstanding_amt": 1100, "phone_no": "GFSGERS", "agent_code": "A003" },
  { "cust_code": "C00002", "cust_name": "Bolt", "cust_city": "NewYork", "working_area": "NewYork", "cust_country": "USA", "grade": 3, "opening_amt": 5000, "receive_amt": 7000, "payment_amt": 9000, "outstanding_amt": 3000, "phone_no": "DDNRDRH", "agent_code": "A008" },
  { "cust_code": "C00018", "cust_name": "Fleming", "cust_city": "Brisban", "working_area": "Brisban", "cust_country": "Australia", "grade": 2, "opening_amt": 7000, "receive_amt": 7000, "payment_amt": 9000, "outstanding_amt": 5000, "phone_no": "NHBGVFC", "agent_code": "A005" },
  { "cust_code": "C00021", "cust_name": "Jacks", "cust_city": "Brisban", "working_area": "Brisban", "cust_country": "Australia", "grade": 1, "opening_amt": 7000, "receive_amt": 7000, "payment_amt": 7000, "outstanding_amt": 7000, "phone_no": "WERTGDF", "agent_code": "A005" },
  { "cust_code": "C00019", "cust_name": "Yearannaidu", "cust_city": "Chennai", "working_area": "Chennai", "cust_country": "India", "grade": 1, "opening_amt": 8000, "receive_amt": 7000, "payment_amt": 7000, "outstanding_amt": 8000, "phone_no": "ZZZZBFV", "agent_code": "A010" },
  { "cust_code": "C00005", "cust_name": "Sasikant", "cust_city": "Mumbai", "working_area": "Mumbai", "cust_country": "India", "grade": 1, "opening_amt": 7000, "receive_amt": 11000, "payment_amt": 7000, "outstanding_amt": 1100, "phone_no": "147-25896312", "agent_code": "A002" },
  { "cust_code": "C00007", "cust_name": "Ramanathan", "cust_city": "Chennai", "working_area": "Chennai", "cust_country": "India", "grade": 1, "opening_amt": 7000, "receive_amt": 11000, "payment_amt": 9000, "outstanding_amt": 9000, "phone_no": "GHRDWSD", "agent_code": "A010" },
  { "cust_code": "C00022", "cust_name": "Avinash", "cust_city": "Mumbai", "working_area": "Mumbai", "cust_country": "India", "grade": 2, "opening_amt": 7000, "receive_amt": 11000, "payment_amt": 9000, "outstanding_amt": 9000, "phone_no": "113-12345678", "agent_code": "A002" },
  { "cust_code": "C00004", "cust_name": "Winston", "cust_city": "Brisban", "working_area": "Brisban", "cust_country": "Australia", "grade": 1, "opening_amt": 5000, "receive_amt": 8000, "payment_amt": 7000, "outstanding_amt": 6000, "phone_no": "AAAAAAA", "agent_code": "A005" },
  { "cust_code": "C00023", "cust_name": "Karl", "cust_city": "London", "working_area": "London", "cust_country": "UK", "grade": 0, "opening_amt": 4000, "receive_amt": 6000, "payment_amt": 7000, "outstanding_amt": 3000, "phone_no": "AAAABAA", "agent_code": "A006" },
  { "cust_code": "C00006", "cust_name": "Shilton", "cust_city": "Torento", "working_area": "Torento", "cust_country": "Canada", "grade": 1, "opening_amt": 10000, "receive_amt": 7000, "payment_amt": 6000, "outstanding_amt": 1100, "phone_no": "DDDDDDD", "agent_code": "A004" },
  { "cust_code": "C00010", "cust_name": "Charles", "cust_city": "Hampshair", "working_area": "Hampshair", "cust_country": "UK", "grade": 3, "opening_amt": 6000, "receive_amt": 4000, "payment_amt": 5000, "outstanding_amt": 5000, "phone_no": "MMMMMMM", "agent_code": "A009" },
  { "cust_code": "C00017", "cust_name": "Srinivas", "cust_city": "Bangalore", "working_area": "Bangalore", "cust_country": "India", "grade": 2, "opening_amt": 8000, "receive_amt": 4000, "payment_amt": 3000, "outstanding_amt": 9000, "phone_no": "AAAAAAB", "agent_code": "A007" },
  { "cust_code": "C00012", "cust_name": "Steven", "cust_city": "San Jose", "working_area": "San Jose", "cust_country": "USA", "grade": 1, "opening_amt": 5000, "receive_amt": 7000, "payment_amt": 9000, "outstanding_amt": 3000, "phone_no": "KRFYGJK", "agent_code": "A012" },
  { "cust_code": "C00008", "cust_name": "Karolina", "cust_city": "Torento", "working_area": "Torento", "cust_country": "Canada", "grade": 1, "opening_amt": 7000, "receive_amt": 7000, "payment_amt": 9000, "outstanding_amt": 5000, "phone_no": "HJKORED", "agent_code": "A004" },
  { "cust_code": "C00003", "cust_name": "Martin", "cust_city": "Torento", "working_area": "Torento", "cust_country": "Canada", "grade": 2, "opening_amt": 8000, "receive_amt": 7000, "payment_amt": 7000, "outstanding_amt": 8000, "phone_no": "MJYURFD", "agent_code": "A004" },
  { "cust_code": "C00009", "cust_name": "Ramesh", "cust_city": "Mumbai", "working_area": "Mumbai", "cust_country": "India", "grade": 3, "opening_amt": 8000, "receive_amt": 7000, "payment_amt": 3000, "outstanding_amt": 12000, "phone_no": "Phone No", "agent_code": "A002" },
  { "cust_code": "C00014", "cust_name": "Rangarappa", "cust_city": "Bangalore", "working_area": "Bangalore", "cust_country": "India", "grade": 2, "opening_amt": 8000, "receive_amt": 11000, "payment_amt": 7000, "outstanding_amt": 12000, "phone_no": "AAAATGF", "agent_code": "A001" },
  { "cust_code": "C00016", "cust_name": "Venkatpati", "cust_city": "Bangalore", "working_area": "Bangalore", "cust_country": "India", "grade": 2, "opening_amt": 8000, "receive_amt": 11000, "payment_amt": 7000, "outstanding_amt": 12000, "phone_no": "JRTVFDD", "agent_code": "A007" },
  { "cust_code": "C00011", "cust_name": "Sundariya", "cust_city": "Chennai", "working_area": "Chennai", "cust_country": "India", "grade": 3, "opening_amt": 7000, "receive_amt": 11000, "payment_amt": 7000, "outstanding_amt": 11000, "phone_no": "PPHGRTS", "agent_code": "A010" }
]
ordini_test = [
  { "ord_num": "200100", "ord_amount": 1000, "advance_amount": 600, "ord_date": "2008-08-01", "cust_code": "C00013", "agent_code": "A003", "order_description": "SOD" },
  { "ord_num": "200110", "ord_amount": 3000, "advance_amount": 500, "ord_date": "2008-04-15", "cust_code": "C00019", "agent_code": "A010", "order_description": "SOD" },
  { "ord_num": "200107", "ord_amount": 4500, "advance_amount": 900, "ord_date": "2008-08-30", "cust_code": "C00007", "agent_code": "A010", "order_description": "SOD" },
  { "ord_num": "200112", "ord_amount": 2000, "advance_amount": 400, "ord_date": "2008-05-30", "cust_code": "C00016", "agent_code": "A007", "order_description": "SOD" },
  { "ord_num": "200113", "ord_amount": 4000, "advance_amount": 600, "ord_date": "2008-06-10", "cust_code": "C00022", "agent_code": "A002", "order_description": "SOD" },
  { "ord_num": "200102", "ord_amount": 2000, "advance_amount": 300, "ord_date": "2008-05-25", "cust_code": "C00012", "agent_code": "A012", "order_description": "SOD" },
  { "ord_num": "200114", "ord_amount": 3500, "advance_amount": 2000, "ord_date": "2008-08-15", "cust_code": "C00002", "agent_code": "A008", "order_description": "SOD" },
  { "ord_num": "200122", "ord_amount": 2500, "advance_amount": 400, "ord_date": "2008-09-16", "cust_code": "C00003", "agent_code": "A004", "order_description": "SOD" },
  { "ord_num": "200118", "ord_amount": 500, "advance_amount": 100, "ord_date": "2008-07-20", "cust_code": "C00023", "agent_code": "A006", "order_description": "SOD" },
  { "ord_num": "200119", "ord_amount": 4000, "advance_amount": 700, "ord_date": "2008-09-16", "cust_code": "C00007", "agent_code": "A010", "order_description": "SOD" },
  { "ord_num": "200121", "ord_amount": 1500, "advance_amount": 600, "ord_date": "2008-09-23", "cust_code": "C00008", "agent_code": "A004", "order_description": "SOD" },
  { "ord_num": "200130", "ord_amount": 2500, "advance_amount": 400, "ord_date": "2008-07-30", "cust_code": "C00025", "agent_code": "A011", "order_description": "SOD" },
  { "ord_num": "200134", "ord_amount": 4200, "advance_amount": 1800, "ord_date": "2008-09-25", "cust_code": "C00004", "agent_code": "A005", "order_description": "SOD" },
  { "ord_num": "200108", "ord_amount": 4000, "advance_amount": 600, "ord_date": "2008-02-15", "cust_code": "C00008", "agent_code": "A004", "order_description": "SOD" },
  { "ord_num": "200103", "ord_amount": 1500, "advance_amount": 700, "ord_date": "2008-05-15", "cust_code": "C00021", "agent_code": "A005", "order_description": "SOD" },
  { "ord_num": "200105", "ord_amount": 2500, "advance_amount": 500, "ord_date": "2008-07-18", "cust_code": "C00025", "agent_code": "A011", "order_description": "SOD" },
  { "ord_num": "200109", "ord_amount": 3500, "advance_amount": 800, "ord_date": "2008-07-30", "cust_code": "C00011", "agent_code": "A010", "order_description": "SOD" },
  { "ord_num": "200101", "ord_amount": 3000, "advance_amount": 1000, "ord_date": "2008-07-15", "cust_code": "C00001", "agent_code": "A008", "order_description": "SOD" },
  { "ord_num": "200111", "ord_amount": 1000, "advance_amount": 300, "ord_date": "2008-07-10", "cust_code": "C00020", "agent_code": "A008", "order_description": "SOD" },
  { "ord_num": "200104", "ord_amount": 1500, "advance_amount": 500, "ord_date": "2008-03-13", "cust_code": "C00006", "agent_code": "A004", "order_description": "SOD" },
  { "ord_num": "200106", "ord_amount": 2500, "advance_amount": 700, "ord_date": "2008-04-20", "cust_code": "C00005", "agent_code": "A002", "order_description": "SOD" },
  { "ord_num": "200125", "ord_amount": 2000, "advance_amount": 600, "ord_date": "2008-10-10", "cust_code": "C00018", "agent_code": "A005", "order_description": "SOD" },
  { "ord_num": "200117", "ord_amount": 800, "advance_amount": 200, "ord_date": "2008-10-20", "cust_code": "C00014", "agent_code": "A001", "order_description": "SOD" },
  { "ord_num": "200123", "ord_amount": 500, "advance_amount": 100, "ord_date": "2008-09-16", "cust_code": "C00022", "agent_code": "A002", "order_description": "SOD" },
  { "ord_num": "200120", "ord_amount": 500, "advance_amount": 100, "ord_date": "2008-07-20", "cust_code": "C00009", "agent_code": "A002", "order_description": "SOD" },
  { "ord_num": "200116", "ord_amount": 500, "advance_amount": 100, "ord_date": "2008-07-13", "cust_code": "C00010", "agent_code": "A009", "order_description": "SOD" },
  { "ord_num": "200124", "ord_amount": 500, "advance_amount": 100, "ord_date": "2008-06-20", "cust_code": "C00017", "agent_code": "A007", "order_description": "SOD" },
  { "ord_num": "200126", "ord_amount": 500, "advance_amount": 100, "ord_date": "2008-06-24", "cust_code": "C00022", "agent_code": "A002", "order_description": "SOD" },
  { "ord_num": "200129", "ord_amount": 2500, "advance_amount": 500, "ord_date": "2008-07-20", "cust_code": "C00024", "agent_code": "A006", "order_description": "SOD" },
  { "ord_num": "200127", "ord_amount": 2500, "advance_amount": 400, "ord_date": "2008-07-20", "cust_code": "C00015", "agent_code": "A003", "order_description": "SOD" },
  { "ord_num": "200128", "ord_amount": 3500, "advance_amount": 1500, "ord_date": "2008-07-20", "cust_code": "C00009", "agent_code": "A002", "order_description": "SOD" },
  { "ord_num": "200135", "ord_amount": 2000, "advance_amount": 800, "ord_date": "2008-09-16", "cust_code": "C00007", "agent_code": "A010", "order_description": "SOD" },
  { "ord_num": "200131", "ord_amount": 900, "advance_amount": 150, "ord_date": "2008-08-26", "cust_code": "C00012", "agent_code": "A012", "order_description": "SOD" },
  { "ord_num": "200133", "ord_amount": 1200, "advance_amount": 400, "ord_date": "2008-06-29", "cust_code": "C00009", "agent_code": "A002", "order_description": "SOD" }
]

from datetime import timedelta
from time import sleep
from flask import Flask, request, jsonify

from flask_jwt_extended import create_access_token
from flask_jwt_extended import get_jwt_identity, get_jwt
from flask_jwt_extended import jwt_required
from flask_jwt_extended import JWTManager
# https://flask-jwt-extended.readthedocs.io/en/stable/basic_usage/

app = Flask(__name__, static_url_path='', static_folder='client')

app.config["JWT_SECRET_KEY"] = "esami-applicazioni-web-2231"
app.config["JWT_ACCESS_TOKEN_EXPIRES"] = timedelta(hours=1)
app.config["JWT_REFRESH_TOKEN_EXPIRES"] = timedelta(days=30)
jwt = JWTManager(app)

users = [
    # (username, password, claims dictionary)
    ('dirigente', 'test', { 'is_manager': True, 'is_agent': False, 'is_customer': False }),
    ('A002', 'test', { 'is_manager': False, 'is_agent': True, 'is_customer': False }),
    ('C00022', 'test', { 'is_manager': False, 'is_agent': False, 'is_customer': True })
]

@app.route("/login", methods=["POST"])
def login():
    username = request.json.get("username", None)
    password = request.json.get("password", None)
    user = next(filter(lambda u: u[0] == username, users), None)
    if not user or user[1] != password:
        return jsonify({"msg": "Bad username or password"}), 401

    access_token = create_access_token(identity=username, additional_claims=user[2])
    return jsonify(access_token=access_token)

@app.route("/refreshtoken", methods=["POST"])
@jwt_required(refresh=True)
def refresh():
    identity = get_jwt_identity()
    user = next(filter(lambda u: u[0] == identity, users), None)
    access_token = create_access_token(identity=identity, additional_claims=user[2])
    return jsonify(access_token=access_token)

@app.route("/protected", methods=["GET"])
@jwt_required()
def protected():
    current_user = get_jwt_identity()
    current_jwt = get_jwt()
    return jsonify(logged_in_as=current_user), 200

@app.route("/orders", methods=["GET"])
@jwt_required()
def orders():
    # sleep(2)
    identity = get_jwt_identity()
    current_jwt = get_jwt()
    allowed = True # current_jwt['is_manager']
    if not allowed:
        return jsonify({"msg": "Forbidden"}), 403
    ordini_utente = ordini_test
    if current_jwt['is_customer']:
        ordini_utente = filter(lambda o: o['cust_code'] == identity, ordini_utente)
    elif current_jwt['is_agent']:
        ordini_utente = filter(lambda o: o['agent_code'] == identity, ordini_utente)
    toSend = []
    for ord in ordini_utente:
        o = ord.copy()
        ag = next(filter(lambda o: o['agent_code'] == ord['agent_code'], agenti_test), None)
        cu = next(filter(lambda o: o['cust_code'] == ord['cust_code'], clienti_test), None)
        o['agent_name'] = (ag and ag['agent_name']) or 'Jane Doe'
        o['cust_name'] = (cu and cu['cust_name']) or 'John Doe'
        # o['agent_phone'] = '123456789'
        toSend.append(o)
    return jsonify(toSend), 200

@app.route("/order/<id>", methods=["DELETE"])
@jwt_required()
def deleteOrders (id):
    global ordini_test
    identity = get_jwt_identity()
    current_jwt = get_jwt()
    ordini_utente = ordini_test
    if current_jwt['is_customer']:
        ordini_utente = filter(lambda order: order['cust_code'] == identity, ordini_utente)
    elif current_jwt['is_agent']:
        ordini_utente = filter(lambda order: order['agent_code'] == identity, ordini_utente)
    ordine = next(filter(lambda o: o['ord_num'] == id, ordini_utente), None)
    if ordine:
        ordini_test = list(filter(lambda o: o['ord_num'] != id, ordini_test))
        return '', 200
    else:
        return jsonify({"msg": "Forbidden"}), 403

@app.route("/customers", methods=["GET"])
@jwt_required()
def customers():
    current_jwt = get_jwt()
    allowed = current_jwt['is_manager'] or current_jwt['is_agent']
    if not allowed:
        return jsonify({"msg": "Forbidden"}), 403
    return jsonify(clienti_test), 200

@app.route("/customers-resume", methods=["GET"])
@jwt_required()
def customers_resume():
    current_jwt = get_jwt()
    allowed = current_jwt['is_manager'] or current_jwt['is_agent']
    if not allowed:
        return jsonify({"msg": "Forbidden"}), 403
    return jsonify(list(map(lambda c: { 'name': c['cust_name'], 'code': c['cust_code'] }, clienti_test))), 200


@app.route("/agents", methods=["GET"])
@jwt_required()
def agents():
    current_jwt = get_jwt()
    allowed = current_jwt['is_manager']
    if not allowed:
        return jsonify({"msg": "Forbidden"}), 403
    return jsonify(agenti_test), 200

@app.route("/agent/<code>", methods=["GET"])
@jwt_required()
def agent(code):
    # current_jwt = get_jwt()
    # allowed = current_jwt['agent_contact']
    # if not allowed:
    #     return jsonify({"msg": "Forbidden"}), 403
    agent = next(filter(lambda b: b['agent_code'] == code, agenti_test), None)
    if not agent:
        return jsonify({'msg': 'Agent not found'}), 404
    return jsonify({
        'agent_code': agent['agent_code'],
        'agent_name': agent['agent_name'],
        'phone_no': agent['phone_no']
    }), 200

@app.route("/customer/<code>", methods=["GET"])
@jwt_required()
def customer(code):
    # current_jwt = get_jwt()
    # allowed = current_jwt['agent_contact']
    # if not allowed:
    #     return jsonify({"msg": "Forbidden"}), 403
    customer = next(filter(lambda b: b['cust_code'] == code, clienti_test), None)
    if not customer:
        return jsonify({'msg': 'Customer not found'}), 404
    return jsonify({
        'cust_code': customer['cust_code'],
        'cust_name': customer['cust_name'],
        'phone_no': customer['phone_no']
    }), 200








@app.route('/')
def root():
    return app.send_static_file('index.html')

@app.route("/api/<name>")
def hello_world(name):
    return f'<p>Hello, {name}!</p>'

if __name__ == '__main__':
    app.run(host='0.0.0.0', debug=True)